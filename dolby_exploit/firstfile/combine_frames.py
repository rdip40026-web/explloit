import os
import re
import crc
import sys
from crc import Calculator, Configuration


out_file = sys.argv[1]

files = os.listdir(".")
order = []

filenum = 1

while True:
	curr = len(order)
	for f in files:
		if f.find(str(filenum) + "_") == 0 and f.find("txt") == -1:
			order.append(f)
	if len(order) == curr:
		break
	filenum += 1
	
config = Configuration(
    		width=16,
    		polynomial=0x18005,
    		init_value=0x00,
    		final_xor_value=0x00,
    		reverse_input=False,
    		reverse_output=False,
	)

calculator = Calculator(config)

frames = []

print(order)

for in_file in order:


	f = open(in_file, 'rb')
	s = f.read()
	frames.append(s[2:])





o = b""
t = 0
for frame in frames:
	if t == 1:
		framesize = 896*2
		
	else:
		framesize= len(frame)
	crc = (int(frame[framesize-2]) << 8) + int(frame[framesize-1])
	print("crc", hex(crc))
	print("size", framesize/2)
	
	#print(hex(calculator.checksum(frame[:framesize ])))
	crc = calculator.checksum(frame[:framesize -2 ])
	print(hex(crc))
	print(crc.to_bytes(2, byteorder='big'))
	o = o + b"\x0b\x77" + frame[:framesize -2] + crc.to_bytes(2, byteorder='big')
	
	
		#o = o + frame[896:925]
	


infile = "./firstbak.mp4"

offset = 0x2eb # data offset



f = open(infile, 'rb')
s = f.read()
f.close()


eac3 = o



d = s[0:offset] + eac3 + s[len(eac3)+offset:]



f = open(out_file, 'wb')
f.write(d)
f.close()



