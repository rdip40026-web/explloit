import os
import re
import crc
import sys
from crc import Calculator, Configuration


out_file = sys.argv[1]

files = os.listdir(".")
order = [
"longmem/3_write_address_and_write",
"longmem/4_write_address_and_write",
"longmem/5_write_address_and_write",
"longmem/6_write_address_and_write",
"longmem/7_write_address_and_write",
"longmem/8_write_address_and_write",
"longmem/9_write_address_and_write",
"longmem/10_write_address_and_write",
"longmem/11_write_address_and_write",
"longmem/12_write_address_and_write",
"longmem/13_write_address_and_write",
"longmem/14_write_address_and_write",
"longmem/15_write_address_and_write",
"longmem/16_write_address_and_write",
"longmem/17_write_address_and_write",
"longmem/18_write_address_and_write",
"longmem/19_write_address_and_write",
"longmem/20_write_address_and_write",
"longmem/21_write_address_and_write",
"longmem/22_write_address_and_write",
"longmem/23_write_address_and_write",
"longmem/24_write_address_and_write",
"longmem/25_write_address_and_write",
"longmem/26_write_address_and_write",
"longmem/27_write_address_and_write",
"longmem/28_write_address_and_write",
"longmem/29_write_address_and_write",
"longmem/30_write_address_and_write",
"longmem/31_write_address_and_write",
"longmem/32_write_address_and_write",
"longmem/33_write_address_and_write",
"longmem/34_write_address_and_write",
"longmem/35_write_address_and_write",
"longmem/36_write_address_and_write",
"longmem/37_write_address_and_write",
"longmem/38_write_address_and_write",
]

filenum = 1.0

while True:
	curr = len(order)
	
	if int(filenum) == filenum:
		for f in files:
			if f.find(str(int(filenum)) + "_") == 0 and f.find("txt") == -1:
				order.append(f)
		if len(order) == curr:
			break
	for f in files:
		if f.find(str(filenum) + "_") == 0 and f.find("txt") == -1:
			order.append(f)

	filenum += 0.25
	
config = Configuration(
    		width=16,
    		polynomial=0x18005,
    		init_value=0x00,
    		final_xor_value=0x00,
    		reverse_input=False,
    		reverse_output=False,#
)

calculator = Calculator(config)

frames = []

for i in range(0, len(order)):
	print(i, order[i])

for in_file in order:


	f = open(in_file, 'rb')
	s = f.read()
	frames.append(s[2:])


for item in order:
	print(item)
	f = open(item, 'rb')
	s = f.read()

	if s.find( b"\x00\xdc") != -1:
		print("found", item)
	f.close()



o = b""
t = 0
for frame in frames:
	if t == 1:
		framesize = 896*2
		
	else:
		framesize= len(frame)
	crc = (int(frame[framesize-2]) << 8) + int(frame[framesize-1])
	print("crc", hex(crc))
	print("size", framesize/2)
	
	#print(hex(calculator.checksum(frame[:framesize ])))
	crc = calculator.checksum(frame[:framesize -2 ])
	print(hex(crc))
	print(crc.to_bytes(2, byteorder='big'))
	o = o + b"\x0b\x77" + frame[:framesize -2] + crc.to_bytes(2, byteorder='big')
	
	
		#o = o + frame[896:925]
	


infile = "./small6.mp4"

offset = 0x324 # data offset



f = open(infile, 'rb')
s = f.read()
f.close()


eac3 = o



d = s[0:offset] + eac3 + s[len(eac3)+offset:]

f = open("temp.ec3", 'wb')
f.write(eac3)
f.close()

f = open(out_file, 'wb')
f.write(d)
f.close()



